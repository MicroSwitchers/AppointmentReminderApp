<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Visual Appointment Timer">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#61dafb">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-TileColor" content="#61dafb">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./vta-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./vta-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./vta-512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="./vta-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./vta-512.png">
    <link rel="shortcut icon" href="./vta-192.png">
    
    <title>Visual Appointment Timer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #61dafb;
            --primary-gradient: linear-gradient(135deg, #61dafb 0%, #21CBF3 50%, #2196F3 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --background-color: #0a0e1a;
            --background-gradient: radial-gradient(ellipse at top, #1a1a2e 0%, #16213e 50%, #0f1419 100%);
            --card-background: rgba(30, 35, 50, 0.95);
            --glass-background: rgba(25, 30, 45, 0.85);
            --glass-light: rgba(255, 255, 255, 0.05);
            --glass-medium: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --light-text-color: #cbd5e0;
            --muted-text-color: #a0aec0;
            --help-text-color: #8892b0;
            --hours-color: #667eea;
            --minutes-color: #f093fb;
            --seconds-color: #4facfe;
            --warning-color: #ffa726;
            --warning-gradient: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            --alarm-color: #ef5350;
            --alarm-gradient: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            --danger-gradient: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            --success-color: #66bb6a;
            --input-background: rgba(45, 55, 75, 0.9);
            --input-border: rgba(255, 255, 255, 0.1);
            --input-border-focus: rgba(97, 218, 251, 0.5);
            --border-radius: 16px;
            --border-radius-lg: 20px;
            --border-radius-xl: 24px;
            --transition-duration: 0.3s;
            --transition-fast: 0.15s;
            --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 12px 40px rgba(0, 0, 0, 0.25);
            --shadow-2xl: 0 20px 60px rgba(0, 0, 0, 0.3);
            --glow-primary: 0 0 30px rgba(97, 218, 251, 0.3);
            --glow-secondary: 0 0 20px rgba(102, 126, 234, 0.2);
            --blur: blur(20px);
            --blur-heavy: blur(40px);
        }

        html, body {
            height: 100%;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background: var(--background-color);
            min-height: 100vh;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: var(--background-gradient);
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
            position: relative;
            overflow-x: hidden;
            animation: fadeIn 0.8s ease-out;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: var(--shadow-xl), var(--glow-primary); }
            50% { box-shadow: var(--shadow-2xl), var(--glow-secondary); }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(97, 218, 251, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(168, 85, 247, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 60% 80%, rgba(240, 147, 251, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: glow 4s ease-in-out infinite;
        }

        .app-container {
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
            animation: slideUp 0.8s ease-out 0.2s both;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-container {
            background: var(--glass-background);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-2xl), inset 0 1px 0 var(--glass-light);
            padding: 40px;
            margin-bottom: 30px;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(97, 218, 251, 0.15);
            position: relative;
            overflow: hidden;
            transition: all var(--transition-duration) ease;
        }

        .main-container:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-2xl), var(--glow-primary), inset 0 1px 0 var(--glass-medium);
            border-color: rgba(97, 218, 251, 0.25);
        }

        .main-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
        }

        .main-container::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(97, 218, 251, 0.05), transparent);
            animation: rotate 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .app-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
            background: var(--primary-gradient);
            border: 2px solid rgba(97, 218, 251, 0.3);
        }

        .app-title {
            font-size: 2.5em;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
            margin: 0;
            line-height: 1.2;
        }

        #currentTime {
            font-size: 1.3em;
            font-weight: 500;
            text-align: center;
            margin: 30px 0;
            color: var(--light-text-color);
            letter-spacing: 1px;
            padding: 16px 24px;
            background: rgba(97, 218, 251, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(97, 218, 251, 0.1);
        }

        .form-section {
            background: var(--card-background);
            border-radius: var(--border-radius-xl);
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg), inset 0 1px 0 var(--glass-light);
            border: 1px solid var(--glass-light);
            position: relative;
            overflow: hidden;
            animation: slideUp 0.8s ease-out 0.4s both;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(97, 218, 251, 0.4), transparent);
        }

        .form-row {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            color: var(--light-text-color);
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        label::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-gradient);
            transition: width var(--transition-duration) ease;
        }

        .form-row:focus-within label::after {
            width: 100%;
        }

        .field-help {
            display: block;
            color: var(--help-text-color);
            font-size: 0.85em;
            margin-top: 6px;
            font-style: italic;
            opacity: 0.8;
            transition: opacity var(--transition-duration) ease;
        }

        .input-feedback {
            font-size: 0.8em;
            margin-top: 4px;
            min-height: 16px;
            transition: all var(--transition-duration) ease;
        }

        .input-feedback.success {
            color: var(--success-color);
        }

        .input-feedback.error {
            color: var(--alarm-color);
        }

        .form-row:focus-within .field-help {
            opacity: 1;
        }

        input, select {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid var(--input-border);
            border-radius: var(--border-radius);
            font-size: 1.1em;
            background: var(--input-background);
            color: var(--text-color);
            transition: all var(--transition-duration) ease;
            position: relative;
            backdrop-filter: blur(10px);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(45, 55, 75, 1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md), 0 0 0 4px rgba(97, 218, 251, 0.1);
        }

        input:hover, select:hover {
            border-color: rgba(97, 218, 251, 0.3);
            transform: translateY(-1px);
        }

        /* Enhanced input styling for better UX */
        input[type="time"] {
            font-family: 'Roboto', monospace;
            letter-spacing: 1px;
            cursor: pointer;
        }

        input[type="text"] {
            text-transform: uppercase;
            text-align: center;
            font-weight: 600;
            letter-spacing: 2px;
        }

        select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2361dafb' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }

        .reminder-section {
            margin-bottom: 20px;
        }

        .reminder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .reminder-item {
            position: relative;
        }

        .reminder-item input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .reminder-item label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-duration) ease;
            margin: 0;
            text-transform: none;
            font-size: 0.95em;
            text-align: center;
            min-height: 44px;
        }

        .reminder-item label:hover {
            background: rgba(97, 218, 251, 0.1);
            border-color: rgba(97, 218, 251, 0.2);
            transform: translateY(-1px);
        }

        .reminder-item input[type="radio"]:checked + label {
            background: rgba(97, 218, 251, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .volume-section {
            margin-bottom: 20px;
        }

        .volume-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .volume-controls label {
            min-width: 70px;
            margin: 0;
            text-transform: none;
        }

        .volume-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: var(--input-background);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            border: none;
            margin: 0;
            padding: 0;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-gradient);
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-gradient);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-md);
        }

        #volumeValue {
            min-width: 45px;
            text-align: right;
            color: var(--primary-color);
            font-weight: 600;
        }

        .add-button {
            width: 100%;
            padding: 18px 20px;
            background: var(--primary-gradient);
            color: #ffffff;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .add-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .add-button:hover::before {
            left: 100%;
        }

        .add-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg), 0 10px 30px rgba(97, 218, 251, 0.3);
            background: var(--secondary-gradient);
        }

        .add-button:active {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .add-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .appointments-section {
            margin-top: 30px;
        }

        .appointments-section h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 24px;
            font-weight: 700;
            font-size: 1.6em;
        }

        .appointment {
            background: var(--card-background);
            padding: 30px 25px;
            margin-bottom: 25px;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg), inset 0 1px 0 var(--glass-light);
            border: 1px solid var(--glass-light);
            position: relative;
            transition: all var(--transition-duration) ease;
            animation: slideUp 0.6s ease-out both;
        }

        .appointment:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-2xl), var(--glow-primary), inset 0 1px 0 var(--glass-medium);
        }

        .appointment-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }

        .appointment-details {
            flex: 1;
        }

        .appointment-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .appointment-timing {
            background: rgba(97, 218, 251, 0.05);
            border: 1px solid rgba(97, 218, 251, 0.1);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            margin: 12px 0;
            font-size: 0.9em;
        }

        .timing-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .timing-row:last-child {
            margin-bottom: 0;
        }

        .timing-label {
            color: var(--light-text-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timing-value {
            color: var(--primary-color);
            font-weight: 600;
            font-family: 'Roboto', monospace;
        }

        .alarm-indicator {
            background: var(--warning-gradient);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            animation: pulse 2s ease-in-out infinite;
        }

        .countdown-container {
            display: flex;
            height: 60px;
            background: rgba(15, 20, 35, 0.9);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--glass-light);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .countdown-segment {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            font-weight: 700;
            letter-spacing: 0.5px;
            position: relative;
            transition: all 0.5s ease-out;
            flex: 1;
            min-width: 0;
        }

        .countdown-number {
            font-size: 1.3em;
            line-height: 1;
            margin-bottom: 2px;
        }

        .countdown-label {
            font-size: 0.7em;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .countdown-segment::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: rgba(255, 255, 255, 0.15);
        }

        .countdown-segment:last-child::after {
            display: none;
        }

        .hours { 
            background: linear-gradient(135deg, var(--hours-color) 0%, #4c6ef5 100%);
        }
        .minutes { 
            background: linear-gradient(135deg, var(--minutes-color) 0%, #f06292 100%);
        }
        .seconds { 
            background: linear-gradient(135deg, var(--seconds-color) 0%, #00d4aa 100%);
        }

        .countdown-text {
            text-align: center;
            font-size: 2.2em;
            font-weight: 800;
            margin: 20px 0;
            color: var(--text-color);
            letter-spacing: 3px;
            font-family: 'Roboto', monospace;
            background: linear-gradient(135deg, #ffffff 0%, var(--primary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 20px rgba(97, 218, 251, 0.3);
            transition: all 0.3s ease;
        }

        .countdown-text.urgent {
            animation: urgentPulse 1s ease-in-out infinite;
            font-size: 2.4em;
        }

        @keyframes urgentPulse {
            0%, 100% { 
                transform: scale(1);
                text-shadow: 0 4px 20px rgba(239, 83, 80, 0.5);
            }
            50% { 
                transform: scale(1.05);
                text-shadow: 0 6px 30px rgba(239, 83, 80, 0.8);
            }
        }

        .countdown-text.warning {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .reminder-indicator {
            height: 10px;
            background: rgba(97, 218, 251, 0.2);
            margin: 20px 0;
            width: 100%;
            border-radius: 5px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            --progress: 0%;
            --indicator-color: var(--primary-gradient);
        }

        .reminder-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--progress);
            background: var(--indicator-color);
            border-radius: 5px;
            transition: width 1s ease-out, background 1s ease;
            box-shadow: 0 0 10px rgba(255, 167, 38, 0.4);
        }

        .reminder-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        .info-container {
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-container p {
            color: var(--light-text-color);
            text-align: center;
            margin: 0;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 700px) {
            .main-container {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .app-title {
                font-size: 1.8em;
            }
            
            .app-icon {
                width: 60px;
                height: 60px;
            }
            
            .reminder-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .appointment {
                padding: 16px;
            }
            
            .appointment-info {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .appointment-buttons {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 16px;
            }
            
            .app-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .app-title {
                font-size: 1.5em;
            }
            
            .reminder-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* Appointment Button Styles */
        .appointment-buttons {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            margin-left: 15px;
        }

        .appointment button {
            min-height: 48px;
            min-width: 48px;
            padding: 12px 18px;
            font-size: 0.9em;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-duration) ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .appointment button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .appointment button:hover::before {
            left: 100%;
        }

        .edit-btn {
            background: var(--success-gradient);
            color: #fff;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .edit-btn:hover {
            background: linear-gradient(135deg, #388E3C 0%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .remove-btn {
            background: var(--danger-gradient);
            color: #fff;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .remove-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 8px 25px rgba(244, 67, 54, 0.3);
        }

        .type-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            font-weight: 700;
            font-size: 0.8em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .past {
            opacity: 0.7;
            filter: grayscale(20%);
        }

        .past .appointment-title {
            text-decoration: line-through;
        }

        @media (max-width: 768px) {
            .appointment-info {
                flex-direction: column;
                gap: 15px;
            }

            .appointment-buttons {
                margin-left: 0;
                justify-content: flex-end;
            }

            .appointment button {
                min-width: 44px;
                padding: 10px 14px;
                font-size: 0.8em;
            }
        }

        /* PWA Enhancement Styles */
        .install-button {
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-duration) ease;
            margin-left: 15px;
            box-shadow: var(--shadow-md);
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .update-button {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            z-index: 9999;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Enhanced mobile support and accessibility */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .main-container {
                margin-top: 10px;
            }
        }

        /* Dark mode enhancements for PWA */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #000000;
                --card-background: rgba(20, 25, 40, 0.95);
            }
        }

        /* Enhanced accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --primary-color: #00ff00;
                --text-color: #ffffff;
                --background-color: #000000;
            }
        }

        /* Focus indicators for accessibility */
        .appointment button:focus-visible,
        .add-button:focus-visible,
        .reminder-item input:focus-visible + label,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            cursor: wait;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-color);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced error states */
        .error {
            border-color: var(--alarm-color) !important;
            box-shadow: 0 0 0 3px rgba(239, 83, 80, 0.2) !important;
        }

        .success {
            border-color: var(--success-color) !important;
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.2) !important;
        }

        /* Haptic feedback indicator */
        .haptic-feedback {
            animation: hapticPulse 0.1s ease-out;
        }

        @keyframes hapticPulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        /* Attention-grabbing animations for countdown phase */
        @keyframes gentleShake {
            0%, 100% { transform: translateX(0) translateY(0); }
            10% { transform: translateX(-2px) translateY(-1px); }
            20% { transform: translateX(2px) translateY(1px); }
            30% { transform: translateX(-1px) translateY(-2px); }
            40% { transform: translateX(1px) translateY(2px); }
            50% { transform: translateX(-2px) translateY(1px); }
            60% { transform: translateX(2px) translateY(-1px); }
            70% { transform: translateX(-1px) translateY(2px); }
            80% { transform: translateX(1px) translateY(-2px); }
            90% { transform: translateX(-2px) translateY(-1px); }
        }

        @keyframes focusGlow {
            0%, 100% { 
                box-shadow: var(--shadow-lg), inset 0 1px 0 var(--glass-light);
                border-color: var(--glass-light);
            }
            50% { 
                box-shadow: var(--shadow-2xl), var(--glow-primary), inset 0 1px 0 var(--glass-medium);
                border-color: rgba(97, 218, 251, 0.4);
            }
        }

        @keyframes pulseAttention {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Appointment attention states */
        .appointment.in-countdown {
            animation: focusGlow 3s ease-in-out infinite;
            position: relative;
            z-index: 10;
            background: radial-gradient(ellipse at center, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.1) 40%, transparent 80%);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .appointment.in-countdown::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(ellipse at center, rgba(255, 193, 7, 0.2) 0%, rgba(255, 152, 0, 0.1) 50%, transparent 80%);
            border-radius: var(--border-radius-xl);
            z-index: -1;
            animation: countdownGlow 2s ease-in-out infinite;
        }

        @keyframes countdownGlow {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.02);
            }
        }

        .appointment.shake-attention {
            animation: gentleShake 0.6s ease-in-out;
        }

        .appointment.urgent-attention {
            animation: gentleShake 0.6s ease-in-out, pulseAttention 2s ease-in-out infinite;
        }

        .appointment.warning-attention {
            animation: focusGlow 2s ease-in-out infinite, pulseAttention 3s ease-in-out infinite;
        }

        /* Modern Floating Timer Hub - Minimalist Design */
        .timer-hub-container {
            position: fixed;
            top: max(20px, env(safe-area-inset-top, 20px));
            right: 20px;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            pointer-events: none;
            will-change: transform;
        }

        .timer-hub-container * {
            pointer-events: auto;
        }

        /* Floating Action Button (FAB) */
        .timer-hub-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            box-shadow: 0 6px 20px rgba(97, 218, 251, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-size: 24px;
            user-select: none;
            touch-action: manipulation;
            outline: none;
            will-change: transform, box-shadow;
        }

        .timer-hub-fab::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-gradient));
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .timer-hub-fab:hover::before {
            opacity: 0.2;
        }

        .timer-hub-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(97, 218, 251, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        .timer-hub-fab:active {
            transform: scale(0.95);
        }

        .timer-hub-fab.has-timers {
            animation: fabPulse 2s ease-in-out infinite;
        }

        @keyframes fabPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 6px 20px rgba(97, 218, 251, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 8px 25px rgba(97, 218, 251, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.2);
            }
        }

        /* Badge for timer count */
        .timer-hub-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef5350;
            color: white;
            border-radius: 50%;
            min-width: 22px;
            height: 22px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(239, 83, 80, 0.4);
            border: 2px solid white;
            padding: 0 4px;
        }

        .timer-hub-badge.visible {
            transform: scale(1);
        }

        .timer-hub-badge.urgent {
            animation: badgeUrgent 1s ease-in-out infinite;
            background: #d32f2f;
        }

        @keyframes badgeUrgent {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(239, 83, 80, 0.4);
            }
            50% { 
                transform: scale(1.15);
                box-shadow: 0 4px 12px rgba(239, 83, 80, 0.6);
            }
        }

        /* Expandable Timer Panel */
        .timer-hub-panel {
            position: absolute;
            top: 70px;
            right: 0;
            width: 320px;
            max-width: calc(100vw - 80px);
            max-height: calc(100vh - 140px);
            background: var(--glass-background);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--glass-light);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-20px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top right;
            overflow: hidden;
            will-change: transform, opacity;
        }

        .timer-hub-panel.expanded {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .timer-hub-panel-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--glass-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.02);
        }

        .timer-hub-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .timer-hub-panel-title::before {
            content: "⏱️";
            font-size: 18px;
        }

        .timer-hub-close {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--muted-text-color);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 16px;
            line-height: 1;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-hub-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            transform: scale(1.1);
        }

        .timer-hub-list {
            max-height: calc(100vh - 220px);
            overflow-y: auto;
            padding: 8px 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(97, 218, 251, 0.3) transparent;
        }

        .timer-hub-list::-webkit-scrollbar {
            width: 4px;
        }

        .timer-hub-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .timer-hub-list::-webkit-scrollbar-thumb {
            background: rgba(97, 218, 251, 0.3);
            border-radius: 2px;
        }

        .timer-hub-list::-webkit-scrollbar-thumb:hover {
            background: rgba(97, 218, 251, 0.5);
        }

        /* Individual Timer Items */
        .timer-hub-item {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timer-hub-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(-2px);
        }

        .timer-hub-item:active {
            transform: translateX(-2px) scale(0.98);
        }

        .timer-hub-item:last-child {
            border-bottom: none;
        }

        .timer-hub-item-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            border: 2px solid currentColor;
            transition: all 0.2s ease;
        }

        .timer-hub-item-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .timer-hub-item.urgent .timer-hub-item-indicator::after {
            opacity: 1;
            animation: indicatorPulse 1s ease-in-out infinite;
        }

        @keyframes indicatorPulse {
            0%, 100% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                opacity: 0.5; 
                transform: translate(-50%, -50%) scale(1.5);
            }
        }

        .timer-hub-item-content {
            flex: 1;
            min-width: 0;
        }

        .timer-hub-item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0 0 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .timer-hub-item-time {
            font-size: 20px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            letter-spacing: 0.5px;
            margin: 0;
            line-height: 1;
        }

        .timer-hub-item-status {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin: 4px 0 0 0;
            opacity: 0.7;
        }

        /* Status-based styling */
        .timer-hub-item.countdown {
            color: var(--primary-color);
        }

        .timer-hub-item.warning {
            color: #ffa726;
        }

        .timer-hub-item.urgent {
            color: #ef5350;
        }

        /* Empty state */
        .timer-hub-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--muted-text-color);
        }

        .timer-hub-empty-icon {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 12px;
        }

        .timer-hub-empty-text {
            font-size: 14px;
            margin: 0;
            opacity: 0.7;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .timer-hub-container {
                top: 16px;
                right: 16px;
            }

            .timer-hub-fab {
                width: 52px;
                height: 52px;
                font-size: 22px;
            }

            .timer-hub-panel {
                width: calc(100vw - 32px);
                max-width: 300px;
                top: 65px;
                right: 0;
                max-height: calc(100vh - 100px);
            }

            .timer-hub-panel-header {
                padding: 12px 16px 8px;
            }

            .timer-hub-panel-title {
                font-size: 14px;
            }

            .timer-hub-item {
                padding: 12px 16px;
            }

            .timer-hub-item-time {
                font-size: 18px;
            }

            .timer-hub-badge {
                top: -4px;
                right: -4px;
                min-width: 20px;
                height: 20px;
                font-size: 10px;
            }

            .timer-hub-list {
                max-height: calc(100vh - 160px);
            }
        }

        @media (max-width: 480px) {
            .timer-hub-container {
                top: 12px;
                right: 12px;
            }

            .timer-hub-fab {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .timer-hub-panel {
                width: calc(100vw - 24px);
                max-width: 280px;
                top: 60px;
                right: 0;
                max-height: calc(100vh - 90px);
            }

            .timer-hub-panel-title {
                font-size: 13px;
            }

            .timer-hub-item-time {
                font-size: 16px;
            }

            .timer-hub-list {
                max-height: calc(100vh - 150px);
            }
        }

        /* Focus and accessibility */
        .timer-hub-fab:focus-visible,
        .timer-hub-close:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .timer-hub-item:focus-visible {
            outline: 1px solid var(--primary-color);
            outline-offset: -1px;
            background: rgba(97, 218, 251, 0.1);
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .timer-hub-fab {
                border: 2px solid var(--text-color);
            }
            
            .timer-hub-panel {
                border: 2px solid var(--text-color);
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .timer-hub-fab,
            .timer-hub-panel,
            .timer-hub-item,
            .timer-hub-badge {
                transition: none;
                animation: none;
            }
        }

        /* Ensure widget doesn't interfere with main content */
        @media (max-height: 600px) {
            .timer-hub-panel {
                max-height: calc(100vh - 120px);
            }
            
            .timer-hub-list {
                max-height: calc(100vh - 200px);
            }
        }

        /* Landscape mode adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .timer-hub-container {
                top: 8px;
                right: 8px;
            }
            
            .timer-hub-panel {
                max-height: calc(100vh - 80px);
                top: 55px;
            }
            
            .timer-hub-list {
                max-height: calc(100vh - 160px);
            }
        }

        /* Ensure FAB doesn't interfere with scrollbars */
        .timer-hub-container {
            margin-right: 0;
            margin-bottom: 0;
        }

        /* Add some breathing room around the FAB */
        @media (min-width: 1200px) {
            .timer-hub-container {
                right: 40px;
                top: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Modern Timer Hub -->
        <div id="timerHubContainer" class="timer-hub-container">
            <!-- Floating Action Button -->
            <button id="timerHubFab" class="timer-hub-fab" onclick="toggleTimerHub()" aria-label="Toggle active timers" title="View active timers">
                ⏱️
                <span id="timerHubBadge" class="timer-hub-badge">0</span>
            </button>
            
            <!-- Expandable Panel -->
            <div id="timerHubPanel" class="timer-hub-panel">
                <div class="timer-hub-panel-header">
                    <h3 class="timer-hub-panel-title">Active Timers</h3>
                    <button class="timer-hub-close" onclick="toggleTimerHub()" aria-label="Close timer panel">×</button>
                </div>
                <div id="timerHubList" class="timer-hub-list">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
        </div>

        <div class="main-container">
            <div class="app-header">
                <img src="vta-512.png" alt="App Icon" class="app-icon">
                <h1 class="app-title">Visual Appointment Reminders</h1>
            </div>
            
            <div id="currentTime"></div>
            
            <div class="form-section">
                <div class="form-row">
                    <label for="tagSelect">Appointment Type:</label>
                    <select id="tagSelect">
                        <option value="General">General</option>
                        <option value="Home Appointment">Home Appointment</option>
                        <option value="Online Appointment">Online Appointment</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Travel">Travel</option>
                        <option value="Report">Report</option>
                        <option value="Service Plan">Service Plan</option>
                        <option value="Stats">Stats</option>
                        <option value="Office">Office</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <label for="descInput">Appointment Initials (2 letters):</label>
                    <input type="text" id="descInput" maxlength="2" placeholder="e.g., DR, MT, WK" pattern="[A-Za-z]{2}" title="Please enter exactly 2 letters">
                    <small class="field-help">Short code to identify this appointment type</small>
                    <div class="input-feedback" id="descFeedback"></div>
                </div>
                
                <div class="form-row">
                    <label for="appointmentTime">Alarm Time:</label>
                    <input type="time" id="appointmentTime" required 
                           step="60" 
                           pattern="[0-9]{2}:[0-9]{2}"
                           title="Select appointment time"
                           autocomplete="off">
                    <small class="field-help">Time when the appointment starts</small>
                    <div class="input-feedback" id="timeFeedback"></div>
                </div>
                
                <div class="reminder-section">
                    <label>Reminder Time:</label>
                    <div class="reminder-grid">
                        <div class="reminder-item">
                            <input type="radio" name="reminder" id="reminder2h" value="120">
                            <label for="reminder2h">2h</label>
                        </div>
                        <div class="reminder-item">
                            <input type="radio" name="reminder" id="reminder1h" value="60" checked>
                            <label for="reminder1h">1h</label>
                        </div>
                        <div class="reminder-item">
                            <input type="radio" name="reminder" id="reminder45m" value="45">
                            <label for="reminder45m">45m</label>
                        </div>
                        <div class="reminder-item">
                            <input type="radio" name="reminder" id="reminder20m" value="20">
                            <label for="reminder20m">20m</label>
                        </div>
                        <div class="reminder-item">
                            <input type="radio" name="reminder" id="reminder10m" value="10">
                            <label for="reminder10m">10m</label>
                        </div>
                        <div class="reminder-item">
                            <input type="radio" name="reminder" id="reminder5m" value="5">
                            <label for="reminder5m">5m</label>
                        </div>
                    </div>
                </div>
                
                <div class="volume-section">
                    <label>Volume Control:</label>
                    <div class="volume-controls">
                        <label for="volumeSlider">Volume:</label>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="80">
                        <span id="volumeValue">80%</span>
                    </div>
                </div>
                
                <button class="add-button" onclick="addAppointment()">Add Appointment</button>
            </div>
            
            <div class="appointments-section" id="appointmentList"></div>
        </div>
        
        <div class="info-container">
            <p>
                <strong>Note:</strong> The Visual Appointment Reminders app does not save data and will not function if your phone or computer goes to sleep. I use it with Microsoft Edge or Chrome browsers to install it as an app on the desktop, then leave it open on my second screen. It acts as a visual reminder of upcoming appointments. Only the reminder time will create an audible alarm; the appointment time is silent so it doesn't disturb meetings that may be beginning at that time.
            </p>
        </div>
    </div>

    <audio id="warningBeep" preload="auto" crossorigin="anonymous">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAeAy6R1++7cyMFKIHH8N6QQAoWXrLq665UFApGn97z" type="audio/wav">
    </audio>

    <audio id="alarmSound" preload="auto" crossorigin="anonymous">
        <source src="https://assets.mixkit.co/active_storage/sfx/209/209-preview.mp3" type="audio/mpeg">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAeAy6R1++7cyMFKIHH8N6QQAoWXrLq665UFApGn97z" type="audio/wav">
    </audio>

    <script>
        // Global variables
        let appointments = [];
        let countdownIntervals = {};
        let reminderIntervals = {};
        let isDataInput = false; 
        let currentVolume = 0.8;
        let editingAppointmentId = null;
        let wakeLock = null;
        let serviceWorkerRegistration = null;
        let isAppInBackground = false;
        let backgroundSyncSupported = false;

        // PWA and background functionality
        class PWAManager {
            constructor() {
                this.isInstalled = false;
                this.deferredPrompt = null;
                this.init();
            }

            async init() {
                // Check if app is installed
                this.checkInstallStatus();
                
                // Listen for install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallButton();
                });

                // Listen for app installed
                window.addEventListener('appinstalled', () => {
                    this.isInstalled = true;
                    this.hideInstallButton();
                    console.log('PWA installed successfully');
                });

                // Handle visibility changes for background functionality
                document.addEventListener('visibilitychange', () => {
                    isAppInBackground = document.hidden;
                    this.handleVisibilityChange();
                });

                // Initialize notification permission
                await this.requestNotificationPermission();
                
                // Setup background sync if supported
                this.setupBackgroundSync();
            }

            checkInstallStatus() {
                // Check various ways to detect if PWA is installed
                if (window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone || 
                    document.referrer.includes('android-app://')) {
                    this.isInstalled = true;
                }
            }

            showInstallButton() {
                // Add install button to UI if not already shown
                if (!document.getElementById('pwa-install-btn')) {
                    const installBtn = document.createElement('button');
                    installBtn.id = 'pwa-install-btn';
                    installBtn.innerHTML = '📱 Install App';
                    installBtn.className = 'install-button';
                    installBtn.onclick = () => this.installApp();
                    
                    const header = document.querySelector('.app-header');
                    header.appendChild(installBtn);
                }
            }

            hideInstallButton() {
                const installBtn = document.getElementById('pwa-install-btn');
                if (installBtn) {
                    installBtn.remove();
                }
            }

            async installApp() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const choiceResult = await this.deferredPrompt.userChoice;
                    
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    
                    this.deferredPrompt = null;
                    this.hideInstallButton();
                }
            }

            async requestNotificationPermission() {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    console.log('Notification permission:', permission);
                    return permission === 'granted';
                }
                return false;
            }

            async setupBackgroundSync() {
                if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                    backgroundSyncSupported = true;
                    console.log('Background sync supported');
                }
            }

            handleVisibilityChange() {
                if (isAppInBackground) {
                    console.log('App moved to background');
                    this.setupBackgroundAlarms();
                } else {
                    console.log('App moved to foreground');
                    this.cancelBackgroundAlarms();
                }
            }

            setupBackgroundAlarms() {
                // Enhanced background functionality for alarms
                appointments.forEach(appointment => {
                    const now = new Date();
                    const timeUntil = appointment.appointmentTime - now;
                    
                    if (timeUntil > 0) {
                        // Use service worker for background notifications
                        this.scheduleBackgroundNotification(appointment, timeUntil);
                    }
                });
            }

            async scheduleBackgroundNotification(appointment, timeUntil) {
                if (serviceWorkerRegistration && 'showNotification' in serviceWorkerRegistration) {
                    // Schedule notification through service worker
                    setTimeout(async () => {
                        if (document.hidden) {
                            await serviceWorkerRegistration.showNotification(
                                'Appointment Reminder',
                                {
                                    body: `${appointment.tag} - Time to get ready!`,
                                    icon: './vta-192.png',
                                    badge: './vta-192.png',
                                    vibrate: [200, 100, 200],
                                    tag: `appointment-${appointment.id}`,
                                    requireInteraction: true,
                                    actions: [
                                        {
                                            action: 'view',
                                            title: 'View',
                                            icon: './vta-192.png'
                                        }
                                    ]
                                }
                            );
                        }
                    }, Math.max(0, timeUntil - (appointment.reminderMinutes * 60 * 1000)));
                }
            }

            cancelBackgroundAlarms() {
                // Cancel any scheduled background notifications
                if (serviceWorkerRegistration) {
                    serviceWorkerRegistration.getNotifications().then(notifications => {
                        notifications.forEach(notification => {
                            if (notification.tag.startsWith('appointment-')) {
                                notification.close();
                            }
                        });
                    });
                }
            }
        }

        // Enhanced Wake Lock Manager
        class WakeLockManager {
            constructor() {
                this.wakeLock = null;
                this.isSupported = 'wakeLock' in navigator;
                this.init();
            }

            init() {
                console.log('Wake lock supported:', this.isSupported);
                
                // Handle visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.wakeLock) {
                        this.release();
                    } else if (!document.hidden && appointments.length > 0) {
                        this.request();
                    }
                });

                // Handle page beforeunload
                window.addEventListener('beforeunload', () => {
                    this.release();
                });
            }

            async request() {
                if (!this.isSupported || this.wakeLock) return;

                try {
                    this.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock acquired');
                    
                    this.wakeLock.addEventListener('release', () => {
                        console.log('Wake lock released');
                        this.wakeLock = null;
                    });
                } catch (err) {
                    console.error('Failed to acquire wake lock:', err);
                }
            }

            release() {
                if (this.wakeLock) {
                    this.wakeLock.release();
                    this.wakeLock = null;
                    console.log('Wake lock manually released');
                }
            }

            update() {
                if (appointments.length > 0) {
                    this.request();
                } else {
                    this.release();
                }
            }
        }

        // Enhanced Audio Manager for PWA
        class AudioManager {
            constructor() {
                this.warningAudio = null;
                this.alarmAudio = null;
                this.audioContext = null;
                this.isAudioReady = false;
                this.init();
            }

            async init() {
                // Initialize audio elements
                this.warningAudio = document.getElementById('warningBeep');
                this.alarmAudio = document.getElementById('alarmSound');

                // Set initial volume
                this.updateVolume(currentVolume);

                // Handle audio context for mobile browsers
                await this.initAudioContext();

                // Preload audio for better performance
                this.preloadAudio();

                // Handle audio loading
                this.warningAudio.addEventListener('canplaythrough', () => {
                    console.log('Warning audio ready');
                });

                this.alarmAudio.addEventListener('canplaythrough', () => {
                    console.log('Alarm audio ready');
                });
            }

            async initAudioContext() {
                try {
                    // Create audio context for better mobile support
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        this.audioContext = new AudioContext();
                        
                        // Resume audio context on first user interaction
                        const resumeAudio = async () => {
                            if (this.audioContext && this.audioContext.state === 'suspended') {
                                await this.audioContext.resume();
                                console.log('Audio context resumed');
                            }
                            document.removeEventListener('touchstart', resumeAudio);
                            document.removeEventListener('click', resumeAudio);
                        };
                        
                        document.addEventListener('touchstart', resumeAudio);
                        document.addEventListener('click', resumeAudio);
                    }
                } catch (error) {
                    console.error('Failed to initialize audio context:', error);
                }
            }

            preloadAudio() {
                // Force load audio files
                this.warningAudio.load();
                this.alarmAudio.load();
            }

            updateVolume(volume) {
                if (this.warningAudio) this.warningAudio.volume = volume;
                if (this.alarmAudio) this.alarmAudio.volume = volume;
            }

            async playWarning() {
                try {
                    // Reset audio to beginning
                    this.warningAudio.currentTime = 0;
                    
                    // Play audio
                    const playPromise = this.warningAudio.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        console.log('Warning audio played successfully');
                    }
                } catch (error) {
                    console.error('Failed to play warning audio:', error);
                    // Fallback: try to play with user gesture
                    this.requestAudioPermission('warning');
                }
            }

            async playAlarm() {
                try {
                    // Reset audio to beginning
                    this.alarmAudio.currentTime = 0;
                    
                    // Play audio
                    const playPromise = this.alarmAudio.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        console.log('Alarm audio played successfully');
                    }
                } catch (error) {
                    console.error('Failed to play alarm audio:', error);
                    // Fallback: try to play with user gesture
                    this.requestAudioPermission('alarm');
                }
            }

            requestAudioPermission(type) {
                // Show user prompt to enable audio
                const playBtn = document.createElement('button');
                playBtn.innerHTML = `🔊 Enable ${type} sound`;
                playBtn.onclick = () => {
                    if (type === 'warning') {
                        this.warningAudio.play();
                    } else {
                        this.alarmAudio.play();
                    }
                    playBtn.remove();
                };
                document.body.appendChild(playBtn);
            }
        }

        // Initialize PWA managers
        const pwaManager = new PWAManager();
        const wakeLockManager = new WakeLockManager();
        const audioManager = new AudioManager();

        // Color mapping for appointment types
        const appointmentColors = {
            'General': '#61dafb',
            'Home Appointment': '#4ade80',
            'Online Appointment': '#3b82f6',
            'Meeting': '#a855f7',
            'Travel': '#f59e0b',
            'Report': '#ef4444',
            'Service Plan': '#06b6d4',
            'Stats': '#84cc16',
            'Office': '#64748b',
            'Other': '#8b5cf6'
        };

        // Helper function to format time in 12-hour format
        function formatTime12Hour(date) {
            return date.toLocaleTimeString([], {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Helper function to convert 24-hour input to 12-hour display
        function format24HourInputTo12Hour(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return formatTime12Hour(date);
        }

        // Helper function to convert 12-hour time back to 24-hour format for input
        function convert12HourTo24Hour(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            if (hours === '12') {
                hours = '00';
            }
            if (modifier === 'PM') {
                hours = parseInt(hours, 10) + 12;
            }
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }

        // Enhanced service worker registration and initialization
        async function initializeApp() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Register service worker with enhanced features
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('Service Worker registered successfully');
                    
                    // Listen for service worker updates
                    serviceWorkerRegistration.addEventListener('updatefound', () => {
                        const newWorker = serviceWorkerRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                showUpdateAvailable();
                            }
                        });
                    });
                    
                    // Listen for messages from service worker
                    navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);
                    
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
            
            // Setup volume control with haptic feedback
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeValue = document.getElementById('volumeValue');
            
            volumeSlider.addEventListener('input', function() {
                currentVolume = this.value / 100;
                volumeValue.textContent = this.value + '%';
                audioManager.updateVolume(currentVolume);
                
                // Haptic feedback on volume change
                hapticFeedback();
            });
            
            // Initialize audio
            await audioManager.init();
            
            // Setup radio button styling
            const radioButtons = document.querySelectorAll('input[name="reminder"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', updateRadioButtonStyles);
            });
            updateRadioButtonStyles();
            
            // Setup keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.target.id === 'appointmentTime' || document.getElementById('appointmentTime').value)) {
                    e.preventDefault();
                    addAppointment();
                }
                
                if (e.key === 'Escape' && editingAppointmentId) {
                    e.preventDefault();
                    cancelEdit();
                }
            });
            
            // Setup form change detection
            const inputFields = document.querySelectorAll('input, select');
            inputFields.forEach(input => {
                input.addEventListener('input', () => {
                    isDataInput = true;
                });
            });
            
            // Setup beforeunload warning
            window.addEventListener('beforeunload', (event) => {
                if (isDataInput) {
                    event.preventDefault();
                    event.returnValue = '';
                }
            });

            // Handle URL parameters for shortcuts
            handleURLParameters();
            
            // Setup smart defaults and Android time input helper
            setupSmartDefaults();
            setupAndroidTimeHelper();
            
            // Initialize timer hub
            setTimeout(() => {
                initializeTimerHub();
            }, 100);
        }

        // Haptic feedback function
        function hapticFeedback(intensity = 'medium') {
            if ('vibrate' in navigator) {
                const patterns = {
                    light: [10],
                    medium: [20],
                    strong: [50]
                };
                navigator.vibrate(patterns[intensity] || patterns.medium);
            }
            
            // Visual feedback for devices without haptic support
            document.body.classList.add('haptic-feedback');
            setTimeout(() => {
                document.body.classList.remove('haptic-feedback');
            }, 100);
        }

        // Enhanced form validation
        function setupFormValidation() {
            const descInput = document.getElementById('descInput');
            const timeInput = document.getElementById('appointmentTime');
            
            descInput.addEventListener('input', () => validateField(descInput));
            descInput.addEventListener('blur', () => validateField(descInput));
            timeInput.addEventListener('input', () => validateField(timeInput));
            timeInput.addEventListener('blur', () => validateField(timeInput));
        }

        function validateField(field) {
            const feedbackElement = document.getElementById(field.id.replace('Input', 'Feedback').replace('Time', 'Feedback'));
            if (!feedbackElement) return;

            let isValid = true;
            let message = '';

            if (field.id === 'descInput') {
                const value = field.value.trim();
                if (value.length === 0) {
                    isValid = false;
                    message = 'Please enter appointment initials';
                } else if (value.length !== 2) {
                    isValid = false;
                    message = 'Please enter exactly 2 letters';
                } else if (!/^[A-Za-z]{2}$/.test(value)) {
                    isValid = false;
                    message = 'Please use only letters';
                } else {
                    isValid = true;
                    message = '✓ Valid initials';
                }
            } else if (field.id === 'appointmentTime') {
                const value = field.value;
                if (!value) {
                    isValid = false;
                    message = 'Please select an appointment time';
                } else {
                    const selectedTime = new Date();
                    const [hours, minutes] = value.split(':');
                    selectedTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    
                    const now = new Date();
                    const timeDiff = selectedTime - now;
                    
                    if (timeDiff < 0) {
                        // Check if it's for tomorrow
                        selectedTime.setDate(selectedTime.getDate() + 1);
                        const newTimeDiff = selectedTime - now;
                        
                        if (newTimeDiff > 0) {
                            const hours = Math.floor(newTimeDiff / (1000 * 60 * 60));
                            const minutes = Math.floor((newTimeDiff % (1000 * 60 * 60)) / (1000 * 60));
                            message = `✓ Appointment at ${formatTime12Hour(selectedTime)} tomorrow (in ${hours}h ${minutes}m)`;
                        } else {
                            isValid = false;
                            message = 'Time has already passed';
                        }
                    } else {
                        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                        
                        if (hours === 0 && minutes < 5) {
                            isValid = false;
                            message = 'Please select a time at least 5 minutes from now';
                        } else {
                            message = `✓ Appointment at ${formatTime12Hour(selectedTime)} (in ${hours}h ${minutes}m)`;
                        }
                    }
                }
            }

            feedbackElement.textContent = message;
            feedbackElement.className = `input-feedback ${isValid ? 'success' : 'error'}`;
            
            // Update field styling
            if (isValid) {
                field.classList.remove('error');
                field.classList.add('success');
            } else {
                field.classList.remove('success');
                field.classList.add('error');
            }

            return isValid;
        }

        // Specific validation functions
        function validateDescInput() {
            return validateField(document.getElementById('descInput'));
        }

        function validateTimeInput() {
            return validateField(document.getElementById('appointmentTime'));
        }

        // Enhanced URL parameter handling for shortcuts
        function handleURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('type')) {
                document.getElementById('tagSelect').value = urlParams.get('type');
            }
            if (urlParams.get('desc')) {
                document.getElementById('descInput').value = urlParams.get('desc').substring(0, 2).toUpperCase();
            }
        }

        // Smart auto-focus (no default time)
        function setupSmartDefaults() {
            // Auto-focus on first input when page loads
            setTimeout(() => {
                document.getElementById('tagSelect').focus();
            }, 500);
        }

        // Android time input helper
        function setupAndroidTimeHelper() {
            const timeInput = document.getElementById('appointmentTime');
            
            // Add change listener for Android time validation
            timeInput.addEventListener('change', function() {
                const value = this.value;
                if (value) {
                    try {
                        // Validate time format for Android
                        const [hours, minutes] = value.split(':').map(num => parseInt(num, 10));
                        
                        if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                            showErrorMessage('Please enter a valid time');
                            this.value = '';
                            return;
                        }
                        
                        // Create a test time to ensure it's valid
                        const testTime = new Date();
                        testTime.setHours(hours, minutes, 0, 0);
                        
                        // Show feedback for users in 12-hour format
                        const feedback = document.getElementById('timeFeedback');
                        if (feedback) {
                            feedback.textContent = `✓ Time set: ${formatTime12Hour(testTime)}`;
                            feedback.className = 'input-feedback success';
                        }
                        
                    } catch (error) {
                        console.error('Time validation error:', error);
                        showErrorMessage('Invalid time format. Please try again.');
                        this.value = '';
                    }
                }
            });
            
            // Add input listener for real-time validation on Android
            timeInput.addEventListener('input', function() {
                const feedback = document.getElementById('timeFeedback');
                if (feedback && this.value) {
                    feedback.textContent = 'Validating time...';
                    feedback.className = 'input-feedback';
                }
            });
            
            // Add focus listener to help Android users
            timeInput.addEventListener('focus', function() {
                if ('vibrate' in navigator) {
                    navigator.vibrate([50]);
                }
                
                // Show help text for users
                const feedback = document.getElementById('timeFeedback');
                if (feedback && !this.value) {
                    feedback.textContent = 'Select appointment time';
                    feedback.className = 'input-feedback';
                }
            });
        }

        // Enhanced add appointment with better UX
        function addAppointment() {
            const addButton = document.querySelector('.add-button');
            const tag = document.getElementById('tagSelect').value;
            const desc = document.getElementById('descInput').value.toUpperCase().trim();
            const time = document.getElementById('appointmentTime').value;

            // Helper function to reset button state
            function resetButtonState() {
                const button = document.querySelector('.add-button');
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                    button.style.pointerEvents = 'auto';
                }
            }

            // Validate inputs
            if (!time) {
                showErrorMessage('Please set a valid appointment time.');
                document.getElementById('appointmentTime').focus();
                hapticFeedback('strong');
                resetButtonState();
                return;
            }

            if (desc && desc.length !== 2) {
                showErrorMessage('Appointment initials must be exactly 2 letters.');
                document.getElementById('descInput').focus();
                hapticFeedback('strong');
                resetButtonState();
                return;
            }

            if (desc && !/^[A-Za-z]{2}$/.test(desc)) {
                showErrorMessage('Appointment initials can only contain letters.');
                document.getElementById('descInput').focus();
                hapticFeedback('strong');
                resetButtonState();
                return;
            }

            // Show loading state
            addButton.classList.add('loading');
            addButton.disabled = true;

            try {
                // Haptic feedback for successful action
                hapticFeedback('medium');

                let reminderMinutes = 60;
                const reminderOptions = document.querySelectorAll('input[name="reminder"]');
                for (const option of reminderOptions) {
                    if (option.checked) {
                        reminderMinutes = parseInt(option.value);
                        break;
                    }
                }

                const now = new Date();
                
                // Enhanced time parsing for Android compatibility
                let appointmentTime;
                try {
                    // Parse the time input more reliably
                    const [hours, minutes] = time.split(':').map(num => parseInt(num, 10));
                    
                    // Create appointment time with explicit hour/minute setting
                    appointmentTime = new Date();
                    appointmentTime.setHours(hours, minutes, 0, 0);
                    
                    // If the time is in the past today, set it for tomorrow
                    if (appointmentTime <= now) {
                        appointmentTime.setDate(appointmentTime.getDate() + 1);
                    }
                } catch (error) {
                    console.error('Time parsing error:', error);
                    showErrorMessage('Invalid time format. Please select a valid time.');
                    resetButtonState();
                    return;
                }
                
                // Check if time is too soon
                const timeDiff = appointmentTime - now;
                if (timeDiff < 5 * 60 * 1000) { // Less than 5 minutes
                    showErrorMessage('Please select a time at least 5 minutes from now.');
                    resetButtonState();
                    return;
                }

            const totalDuration = appointmentTime - now;

            if (editingAppointmentId) {
                // Edit existing appointment
                const appointmentIndex = appointments.findIndex(app => app.id === editingAppointmentId);
                if (appointmentIndex !== -1) {
                    clearInterval(countdownIntervals[editingAppointmentId]);
                    clearInterval(reminderIntervals[editingAppointmentId]);

                    appointments[appointmentIndex] = {
                        id: editingAppointmentId,
                        tag: tag,
                        desc: desc || tag.substring(0, 2).toUpperCase(),
                        appointmentTime: appointmentTime,
                        reminderMinutes: reminderMinutes,
                        totalDuration: totalDuration
                    };
                }
                editingAppointmentId = null;
                addButton.textContent = 'Add Appointment';
                showSuccessMessage('Appointment updated successfully!');
            } else {
                // Add new appointment
                const appointment = {
                    id: Date.now(),
                    tag: tag,
                    desc: desc || tag.substring(0, 2).toUpperCase(),
                    appointmentTime: appointmentTime,
                    reminderMinutes: reminderMinutes,
                    totalDuration: totalDuration
                };
                appointments.push(appointment);
                showSuccessMessage('Appointment added successfully!');
            }

            appointments.sort((a, b) => a.appointmentTime - b.appointmentTime);
            updateAppointmentList();
            updateWakeLock();
            updatePageTitle();
            
            // Clear loading state immediately
            resetButtonState();
            
            // Reset form with enhanced UX
            setTimeout(() => {
                document.getElementById('descInput').value = '';
                document.getElementById('appointmentTime').value = '';
                document.getElementById('tagSelect').focus();
            }, 100);

            isDataInput = false; // Reset form state
            
            } catch (error) {
                console.error('Error adding appointment:', error);
                showErrorMessage('Failed to add appointment. Please try again.');
                resetButtonState();
            }
        }

        function handleServiceWorkerMessage(event) {
            const { type, payload } = event.data;
            
            switch (type) {
                case 'SYNC_APPOINTMENTS':
                    console.log('Appointments synced:', payload);
                    break;
                case 'CHECK_APPOINTMENTS':
                    console.log('Background appointment check:', payload);
                    break;
            }
        }

        // Enhanced message system
        function showErrorMessage(message) {
            showMessage(message, 'error');
        }

        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        function showMessage(message, type = 'info') {
            // Remove any existing messages
            const existingMessage = document.querySelector('.app-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageEl = document.createElement('div');
            messageEl.className = `app-message ${type}`;
            messageEl.innerHTML = `
                <div class="message-content">
                    <span class="message-icon">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                    <span class="message-text">${message}</span>
                    <button class="message-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add styles if not already added
            if (!document.querySelector('.message-styles')) {
                const styles = document.createElement('style');
                styles.className = 'message-styles';
                styles.textContent = `
                    .app-message {
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 10000;
                        animation: slideDown 0.3s ease-out;
                        max-width: 90vw;
                        box-shadow: var(--shadow-2xl);
                    }
                    .app-message.success { background: var(--success-gradient); }
                    .app-message.error { background: var(--alarm-gradient); }
                    .app-message.info { background: var(--primary-gradient); }
                    .message-content {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 16px 20px;
                        border-radius: var(--border-radius);
                        color: white;
                        font-weight: 600;
                        backdrop-filter: blur(10px);
                    }
                    .message-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 20px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s ease;
                    }
                    .message-close:hover {
                        background-color: rgba(255, 255, 255, 0.2);
                    }
                `;
                document.head.appendChild(styles);
            }

            document.body.appendChild(messageEl);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageEl.parentElement) {
                    messageEl.style.animation = 'slideUp 0.3s ease-out forwards';
                    setTimeout(() => messageEl.remove(), 300);
                }
            }, 5000);

            return messageEl;
        }

        function showUpdateAvailable() {
            const updateBtn = document.createElement('button');
            updateBtn.innerHTML = '🔄 Update Available - Click to Refresh';
            updateBtn.className = 'update-button';
            updateBtn.onclick = () => {
                window.location.reload();
            };
            
            document.body.insertBefore(updateBtn, document.body.firstChild);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (updateBtn.parentNode) {
                    updateBtn.remove();
                }
            }, 10000);
        }

        function handleURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'add') {
                // Focus on the first input field
                document.getElementById('tagSelect').focus();
            }
        }

        // Update wake lock management
        function updateWakeLock() {
            wakeLockManager.update();
        }

        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = `Current Time: ${formatTime12Hour(now)}`;
        }

        // Update radio button styles
        function updateRadioButtonStyles() {
            const reminderItems = document.querySelectorAll('.reminder-item');
            reminderItems.forEach(item => {
                const radio = item.querySelector('input[type="radio"]');
                const label = item.querySelector('label');
                
                if (radio.checked) {
                    label.style.background = 'rgba(97, 218, 251, 0.1)';
                    label.style.borderColor = 'var(--primary-color)';
                    label.style.color = 'var(--primary-color)';
                } else {
                    label.style.background = 'rgba(255, 255, 255, 0.03)';
                    label.style.borderColor = 'rgba(255, 255, 255, 0.05)';
                    label.style.color = 'var(--light-text-color)';
                }
            });
        }

        // Note: Enhanced addAppointment function is already defined above

        // Update appointment list display
        function updateAppointmentList() {
            const list = document.getElementById('appointmentList');
            
            if (appointments.length === 0) {
                list.innerHTML = '';
                updateTimerHub(); // Update timer hub when no appointments
                return;
            }
            
            list.innerHTML = '<h2>Appointments</h2>';
            
            appointments.forEach((app) => {
                const appointmentElement = document.createElement('div');
                appointmentElement.className = 'appointment';
                appointmentElement.id = `appointment-${app.id}`;
                
                // Get the color for this appointment type
                const appointmentColor = appointmentColors[app.tag] || '#61dafb';
                
                // Apply color coding to the appointment border
                appointmentElement.style.borderLeft = `4px solid ${appointmentColor}`;
                appointmentElement.style.boxShadow = `0 2px 8px rgba(97, 218, 251, 0.08), inset 0 0 0 1px ${appointmentColor}20`;
                
                appointmentElement.innerHTML = `
                    <div class="appointment-info">
                        <div class="appointment-details">
                            <div class="appointment-title" style="color: ${appointmentColor};">
                                <div class="type-indicator" style="background: ${appointmentColor};">${app.desc || app.tag.substring(0, 2).toUpperCase()}</div>
                                <span>${app.tag}</span>
                                ${app.desc && app.desc !== app.tag.substring(0, 2).toUpperCase() ? `<span style="opacity: 0.8;">(${app.desc})</span>` : ''}
                            </div>
                            <div class="appointment-timing">
                                <div class="timing-row">
                                    <span class="timing-label">🕐 Appointment Time:</span>
                                    <span class="timing-value">${formatTime12Hour(app.appointmentTime)}</span>
                                </div>
                                <div class="timing-row">
                                    <span class="timing-label">⏰ Reminder:</span>
                                    <span class="timing-value">${app.reminderMinutes} minutes before</span>
                                </div>
                                <div class="timing-row">
                                    <span class="timing-label">📅 Date:</span>
                                    <span class="timing-value">${app.appointmentTime.toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        <div class="appointment-buttons">
                            <button class="edit-btn" onclick="editAppointment(${app.id})" title="Edit this appointment">
                                ✏️ <span>Edit</span>
                            </button>
                            <button class="remove-btn" onclick="removeAppointment(${app.id})" title="Remove this appointment">
                                🗑️ <span>Remove</span>
                            </button>
                        </div>
                    </div>
                    <div class="countdown-container" id="countdown-${app.id}">
                        <div class="countdown-segment hours" id="hours-${app.id}">
                            <div class="countdown-number">0</div>
                            <div class="countdown-label">Hours</div>
                        </div>
                        <div class="countdown-segment minutes" id="minutes-${app.id}">
                            <div class="countdown-number">0</div>
                            <div class="countdown-label">Minutes</div>
                        </div>
                        <div class="countdown-segment seconds" id="seconds-${app.id}">
                            <div class="countdown-number">0</div>
                            <div class="countdown-label">Seconds</div>
                        </div>
                    </div>
                    <div class="reminder-indicator" id="reminder-indicator-${app.id}"></div>
                    <div class="countdown-text" id="countdown-text-${app.id}">Loading...</div>
                `;
                list.appendChild(appointmentElement);
                
                if (!countdownIntervals[app.id]) {
                    startCountdown(app);
                }
                if (!reminderIntervals[app.id]) {
                    setReminder(app);
                }
            });
            
            // Update timer hub whenever appointment list changes
            updateTimerHub();
        }

        // Edit appointment
        function editAppointment(id) {
            const appointment = appointments.find(app => app.id === id);
            if (appointment) {
                document.getElementById('tagSelect').value = appointment.tag;
                document.getElementById('descInput').value = appointment.desc;
                document.getElementById('appointmentTime').value = appointment.time;
                
                const reminderOptions = document.querySelectorAll('input[name="reminder"]');
                reminderOptions.forEach(option => {
                    option.checked = parseInt(option.value) === appointment.reminderMinutes;
                });
                
                updateRadioButtonStyles();
                editingAppointmentId = id;
                document.querySelector('.add-button').textContent = 'Update Appointment';
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Cancel edit
        function cancelEdit() {
            editingAppointmentId = null;
            document.querySelector('.add-button').textContent = 'Add Appointment';
            document.getElementById('descInput').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('reminder1h').checked = true;
            updateRadioButtonStyles();
        }

        // Remove appointment
        function removeAppointment(id) {
            if (editingAppointmentId === id) {
                cancelEdit();
            }
            
            appointments = appointments.filter(app => app.id !== id);
            clearInterval(countdownIntervals[id]);
            delete countdownIntervals[id];
            clearInterval(reminderIntervals[id]);
            delete reminderIntervals[id];
            
            updateAppointmentList();
            updateWakeLock();
            updatePageTitle();
            isDataInput = appointments.length > 0;
        }

        // Start countdown for appointment
        function startCountdown(appointment) {
            function updateCountdown() {
                const now = new Date();
                let timeLeft = appointment.appointmentTime - now;

                const hoursElement = document.getElementById(`hours-${appointment.id}`);
                const minutesElement = document.getElementById(`minutes-${appointment.id}`);
                const secondsElement = document.getElementById(`seconds-${appointment.id}`);
                const countdownText = document.getElementById(`countdown-text-${appointment.id}`);
                const reminderIndicator = document.getElementById(`reminder-indicator-${appointment.id}`);

                // Calculate reminder seconds early for use throughout the function
                const reminderSeconds = appointment.reminderMinutes * 60;

                if (!hoursElement || !minutesElement || !secondsElement || !countdownText || !reminderIndicator) {
                    clearInterval(countdownIntervals[appointment.id]);
                    delete countdownIntervals[appointment.id];
                    return;
                }

                const totalSeconds = Math.floor(timeLeft / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                // Calculate proportional widths for visual bars
                const totalDuration = appointment.totalDuration || 24 * 3600 * 1000; // Default to 24 hours
                const remainingDuration = Math.max(0, timeLeft);
                const progressPercent = Math.max(0, Math.min(100, (remainingDuration / totalDuration) * 100));

                // Calculate individual segment widths based on their contribution
                const hoursPercent = hours > 0 ? (hours / 24) * 100 : 0;
                const minutesPercent = minutes > 0 ? (minutes / 60) * (100 - hoursPercent) / 2 : 0;
                const secondsPercent = Math.max(10, 100 - hoursPercent - minutesPercent); // Ensure seconds always visible

                // Update segment widths and content
                hoursElement.style.flex = `${Math.max(0.1, hoursPercent / 100)}`;
                minutesElement.style.flex = `${Math.max(0.3, minutesPercent / 100 + 0.2)}`;
                secondsElement.style.flex = `${Math.max(0.3, secondsPercent / 100 + 0.2)}`;

                // Enhanced visual countdown segments with proper content
                hoursElement.innerHTML = `
                    <div class="countdown-number">${hours}</div>
                    <div class="countdown-label">Hours</div>
                `;
                minutesElement.innerHTML = `
                    <div class="countdown-number">${minutes}</div>
                    <div class="countdown-label">Minutes</div>
                `;
                secondsElement.innerHTML = `
                    <div class="countdown-number">${seconds}</div>
                    <div class="countdown-label">Seconds</div>
                `;

                // Hide segments when they're zero (except seconds)
                hoursElement.style.display = hours > 0 ? 'flex' : 'none';
                minutesElement.style.display = (minutes > 0 || hours > 0) ? 'flex' : 'none';

                // Enhanced countdown text with smart formatting
                let displayText;
                if (hours > 0) {
                    displayText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else if (minutes > 0) {
                    displayText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    displayText = `${seconds}s`;
                }
                countdownText.textContent = displayText;

                // Enhanced visual states based on time remaining with attention animations
                countdownText.className = 'countdown-text';
                const appointmentElement = document.getElementById(`appointment-${appointment.id}`);
                
                // Remove all attention classes first
                if (appointmentElement) {
                    appointmentElement.classList.remove('in-countdown', 'shake-attention', 'urgent-attention', 'warning-attention');
                }
                
                if (totalSeconds <= 60) {
                    countdownText.classList.add('urgent');
                    if (appointmentElement) {
                        appointmentElement.style.boxShadow = '0 0 20px rgba(239, 83, 80, 0.4)';
                        appointmentElement.classList.add('urgent-attention');
                    }
                } else if (totalSeconds <= 300) { // 5 minutes
                    countdownText.classList.add('warning');
                    if (appointmentElement) {
                        appointmentElement.style.boxShadow = '0 0 15px rgba(255, 167, 38, 0.3)';
                        appointmentElement.classList.add('warning-attention');
                    }
                } else if (totalSeconds <= reminderSeconds) { // In countdown phase
                    if (appointmentElement) {
                        appointmentElement.style.boxShadow = '';
                        appointmentElement.classList.add('in-countdown');
                        
                        // Add gentle shake every 5 seconds during countdown phase
                        if (!appointment.shakeInterval) {
                            appointment.shakeInterval = setInterval(() => {
                                if (appointmentElement) {
                                    appointmentElement.classList.add('shake-attention');
                                    setTimeout(() => {
                                        if (appointmentElement) {
                                            appointmentElement.classList.remove('shake-attention');
                                        }
                                    }, 600);
                                }
                            }, 5000);
                        }
                    }
                } else {
                    if (appointmentElement) {
                        appointmentElement.style.boxShadow = '';
                        // Clear shake interval when not in countdown
                        if (appointment.shakeInterval) {
                            clearInterval(appointment.shakeInterval);
                            appointment.shakeInterval = null;
                        }
                    }
                }

                // Enhanced reminder indicator with proper animation
                const reminderProgress = Math.max(0, Math.min(100, ((reminderSeconds - totalSeconds) / reminderSeconds) * 100));
                
                // Update the pseudo-element via CSS custom property
                reminderIndicator.style.setProperty('--progress', `${reminderProgress}%`);
                
                // Apply different colors based on urgency
                if (totalSeconds <= 60) {
                    reminderIndicator.style.setProperty('--indicator-color', 'var(--alarm-gradient)');
                } else if (totalSeconds <= reminderSeconds) {
                    reminderIndicator.style.setProperty('--indicator-color', 'var(--warning-gradient)');
                } else {
                    reminderIndicator.style.setProperty('--indicator-color', 'var(--primary-gradient)');
                }

                // Trigger reminder
                if (!appointment.reminderPassed && totalSeconds <= reminderSeconds) {
                    appointment.reminderPassed = true;
                    playWarningBeep();
                    showMessage(`⏰ Reminder: ${appointment.tag} appointment in ${appointment.reminderMinutes} minutes!`, 'info');
                    
                    // Enhanced notification for Android
                    if (document.hidden && Notification.permission === 'granted') {
                        showNotification(
                            `⏰ ${appointment.tag} Reminder`, 
                            `Your appointment starts in ${appointment.reminderMinutes} minutes!`,
                            { appointmentId: appointment.id }
                        );
                    }
                }
                
                // Appointment time reached
                if (timeLeft <= 0) {
                    clearInterval(countdownIntervals[appointment.id]);
                    delete countdownIntervals[appointment.id];
                    
                    // Clear shake interval when appointment ends
                    if (appointment.shakeInterval) {
                        clearInterval(appointment.shakeInterval);
                        appointment.shakeInterval = null;
                    }
                    
                    playAlarmSound();
                    
                    countdownText.textContent = "TIME!";
                    countdownText.className = 'countdown-text urgent';
                    
                    hoursElement.innerHTML = '<div class="countdown-number">0</div><div class="countdown-label">Hours</div>';
                    minutesElement.innerHTML = '<div class="countdown-number">0</div><div class="countdown-label">Minutes</div>';
                    secondsElement.innerHTML = '<div class="countdown-number">0</div><div class="countdown-label">Seconds</div>';
                    
                    if (appointmentElement) {
                        appointmentElement.classList.add('past');
                        appointmentElement.style.boxShadow = '0 0 25px rgba(239, 83, 80, 0.6)';
                    }
                    
                    showMessage(`🚨 ${appointment.tag} appointment time is NOW!`, 'error');
                    
                    // Enhanced notification for Android
                    if (document.hidden && Notification.permission === 'granted') {
                        showNotification(
                            `🚨 ${appointment.tag} Time!`, 
                            `Your appointment is starting NOW!`,
                            { appointmentId: appointment.id, requireInteraction: true }
                        );
                    }
                    
                    // Auto-remove past appointments after 5 minutes
                    setTimeout(() => {
                        removeAppointment(appointment.id);
                    }, 5 * 60 * 1000);
                }
                
                // Update timer hub with current countdown status - throttled for efficiency
                if (!appointment.lastTimerHubUpdate || Date.now() - appointment.lastTimerHubUpdate > 500) {
                    appointment.lastTimerHubUpdate = Date.now();
                    updateTimerHub();
                }
            }

            updateCountdown();
            countdownIntervals[appointment.id] = setInterval(updateCountdown, 1000);
        }

        // Set reminder for appointment
        function setReminder(appointment) {
            reminderIntervals[appointment.id] = setInterval(() => {
                const now = new Date();
                const timeUntilAppointment = appointment.appointmentTime - now;
                const minutesUntilAppointment = Math.floor(timeUntilAppointment / (1000 * 60));
                
                if (minutesUntilAppointment === appointment.reminderMinutes) {
                    playWarningBeep();
                    clearInterval(reminderIntervals[appointment.id]);
                    delete reminderIntervals[appointment.id];
                }
            }, 60000);
        }

        // Play warning beep with enhanced PWA support
        async function playWarningBeep() {
            // Use the audio manager
            await audioManager.playWarning();
            
            // Vibrate on mobile devices
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // Show notification if app is in background - Android optimized
            if (document.hidden && Notification.permission === 'granted') {
                showNotification(
                    '⏰ Appointment Reminder', 
                    'Your appointment reminder time has been reached!',
                    { silent: false, requireInteraction: true }
                );
            }
        }

        // Play alarm sound with enhanced PWA support
        async function playAlarmSound() {
            // Use the audio manager
            await audioManager.playAlarm();
            
            // Stronger vibration for appointment time
            if ('vibrate' in navigator) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // Show notification if app is in background - Android optimized
            if (document.hidden && Notification.permission === 'granted') {
                showNotification(
                    '🚨 Appointment Time!', 
                    'Your appointment time is NOW!',
                    { silent: false, requireInteraction: true, renotify: true }
                );
            }
        }

        // Enhanced notification function with Android optimizations
        async function showNotification(title, body, options = {}) {
            // Enhanced Android-compatible notification options
            const defaultOptions = {
                body: body,
                icon: './vta-192.png',
                badge: './vta-192.png',
                vibrate: [200, 100, 200, 100, 200], // Enhanced vibration pattern
                requireInteraction: true,
                tag: 'appointment-notification-' + Date.now(), // Unique tag for each notification
                renotify: true, // Force notification to show even if tag exists
                silent: false, // Ensure sound plays
                timestamp: Date.now(),
                data: {
                    timestamp: Date.now(),
                    url: window.location.href,
                    appointmentId: options.appointmentId || null
                },
                actions: [
                    {
                        action: 'view',
                        title: '👁️ View App',
                        icon: './vta-192.png'
                    },
                    {
                        action: 'dismiss',
                        title: '✖️ Dismiss',
                        icon: './vta-192.png'
                    }
                ]
            };

            // Merge custom options with defaults
            const notificationOptions = { ...defaultOptions, ...options };

            try {
                // Check if we have permission
                if (Notification.permission !== 'granted') {
                    console.warn('Notification permission not granted');
                    return;
                }

                // Try service worker first for persistent notifications
                if (serviceWorkerRegistration && 'showNotification' in serviceWorkerRegistration) {
                    console.log('Showing service worker notification:', title);
                    await serviceWorkerRegistration.showNotification(title, notificationOptions);
                } 
                // Fallback to regular notification API
                else if ('Notification' in window) {
                    console.log('Showing regular notification:', title);
                    const notification = new Notification(title, notificationOptions);
                    
                    // Enhanced Android event handling
                    notification.onclick = function(event) {
                        console.log('Notification clicked');
                        event.preventDefault();
                        window.focus();
                        if (notificationOptions.data.appointmentId) {
                            scrollToAppointment(notificationOptions.data.appointmentId);
                        }
                        notification.close();
                    };
                    
                    notification.onerror = function(error) {
                        console.error('Notification error:', error);
                    };
                    
                    // Auto-close after 10 seconds on Android
                    setTimeout(() => {
                        if (notification) {
                            notification.close();
                        }
                    }, 10000);
                }
                
                // Additional Android fallback - show in-app alert if notifications fail
                else {
                    console.warn('No notification API available, showing alert');
                    showInAppAlert(title, body);
                }
                
            } catch (error) {
                console.error('Failed to show notification:', error);
                // Fallback to in-app alert
                showInAppAlert(title, body);
            }
        }

        // In-app alert fallback for Android
        function showInAppAlert(title, body) {
            const alertContainer = document.createElement('div');
            alertContainer.className = 'android-alert-container';
            alertContainer.innerHTML = `
                <div class="android-alert">
                    <div class="android-alert-icon">🔔</div>
                    <div class="android-alert-content">
                        <div class="android-alert-title">${title}</div>
                        <div class="android-alert-body">${body}</div>
                    </div>
                    <button class="android-alert-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add styles for Android alert
            if (!document.querySelector('.android-alert-styles')) {
                const styles = document.createElement('style');
                styles.className = 'android-alert-styles';
                styles.textContent = `
                    .android-alert-container {
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 10000;
                        max-width: 90vw;
                        animation: slideDown 0.3s ease-out;
                    }
                    .android-alert {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 16px 20px;
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        min-width: 300px;
                        backdrop-filter: blur(10px);
                    }
                    .android-alert-icon {
                        font-size: 24px;
                        flex-shrink: 0;
                    }
                    .android-alert-content {
                        flex: 1;
                    }
                    .android-alert-title {
                        font-weight: 700;
                        font-size: 16px;
                        margin-bottom: 4px;
                    }
                    .android-alert-body {
                        font-size: 14px;
                        opacity: 0.9;
                    }
                    .android-alert-close {
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        border-radius: 50%;
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        font-size: 18px;
                        transition: background 0.2s;
                    }
                    .android-alert-close:hover {
                        background: rgba(255,255,255,0.3);
                    }
                    @keyframes slideDown {
                        from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                        to { transform: translateX(-50%) translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(alertContainer);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (alertContainer.parentElement) {
                    alertContainer.style.animation = 'slideUp 0.3s ease-out forwards';
                    setTimeout(() => alertContainer.remove(), 300);
                }
            }, 8000);
            
            // Vibrate on Android
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }

        // Update page title with next appointment
        function updatePageTitle() {
            if (appointments.length === 0) {
                document.title = 'Visual Appointment Timer';
                return;
            }

            const now = new Date();
            const nextAppointment = appointments.find(app => app.appointmentTime > now);
            
            if (nextAppointment) {
                const timeLeft = nextAppointment.appointmentTime - now;
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const appointmentTime12h = formatTime12Hour(nextAppointment.appointmentTime);
                document.title = `${hours}h ${minutes}m - ${nextAppointment.tag} at ${appointmentTime12h}`;
            }
        }

        // Update page title every minute
        setInterval(updatePageTitle, 60000);

        // Cancel edit function
        function cancelEdit() {
            editingAppointmentId = null;
            document.querySelector('.add-button').textContent = 'Add Appointment';
            
            // Reset form
            document.getElementById('descInput').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('tagSelect').value = 'General';
            document.getElementById('reminder1h').checked = true;
            updateRadioButtonStyles();
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('tagSelect').focus();
            }, 100);
            
            showMessage('Edit cancelled', 'info');
        }

        // Remove appointment with confirmation
        function removeAppointment(id) {
            const appointment = appointments.find(app => app.id === id);
            if (!appointment) return;
            
            if (confirm(`Are you sure you want to remove the ${appointment.tag} appointment?`)) {
                // Clear intervals
                clearInterval(countdownIntervals[id]);
                clearInterval(reminderIntervals[id]);
                delete countdownIntervals[id];
                delete reminderIntervals[id];
                
                // Clear shake interval if it exists
                if (appointment.shakeInterval) {
                    clearInterval(appointment.shakeInterval);
                    appointment.shakeInterval = null;
                }
                
                // Remove from array
                appointments = appointments.filter(app => app.id !== id);
                
                updateAppointmentList();
                updateTimerHub(); // Ensure timer hub is updated
                updateWakeLock();
                updatePageTitle();
                
                hapticFeedback('strong');
                showSuccessMessage('Appointment removed successfully!');
            }
        }

        // Edit appointment function (enhanced version)
        function editAppointment(id) {
            const appointment = appointments.find(app => app.id === id);
            if (appointment) {
                editingAppointmentId = id;
                
                document.getElementById('tagSelect').value = appointment.tag;
                document.getElementById('descInput').value = appointment.desc || '';
                
                // Enhanced time setting for Android compatibility
                try {
                    // The input still needs 24-hour format for functionality
                    const timeString = appointment.appointmentTime.toTimeString().slice(0, 5);
                    document.getElementById('appointmentTime').value = timeString;
                    
                    // Show user-friendly 12-hour format feedback
                    const feedback = document.getElementById('timeFeedback');
                    if (feedback) {
                        feedback.textContent = `✓ Time set: ${formatTime12Hour(appointment.appointmentTime)}`;
                        feedback.className = 'input-feedback success';
                    }
                    
                    // Validate the time was set correctly (Android fix)
                    setTimeout(() => {
                        const timeInput = document.getElementById('appointmentTime');
                        if (timeInput.value !== timeString) {
                            console.warn('Time input issue detected, retrying...');
                            timeInput.value = timeString;
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('Error setting time for edit:', error);
                    showErrorMessage('Error loading appointment time. Please set the time manually.');
                }
                
                // Set reminder option
                const reminderRadio = document.querySelector(`input[name="reminder"][value="${appointment.reminderMinutes}"]`);
                if (reminderRadio) {
                    reminderRadio.checked = true;
                    updateRadioButtonStyles();
                }
                
                document.querySelector('.add-button').textContent = 'Update Appointment';
                document.getElementById('tagSelect').focus();
                
                hapticFeedback('medium');
                showMessage('Editing appointment - make your changes and click Update', 'info');
            }
        }

        // Modern Timer Hub Management - Optimized
        let timerHubExpanded = false;
        let timerHubAutoHideTimeout = null;
        let timerHubUpdateThrottle = null;
        let lastTimerHubState = null;

        function toggleTimerHub() {
            timerHubExpanded = !timerHubExpanded;
            const panel = document.getElementById('timerHubPanel');
            const fab = document.getElementById('timerHubFab');
            
            if (timerHubExpanded) {
                panel.classList.add('expanded');
                fab.setAttribute('aria-expanded', 'true');
                // Auto-hide after 10 seconds if no interaction
                timerHubAutoHideTimeout = setTimeout(() => {
                    if (timerHubExpanded) {
                        toggleTimerHub();
                    }
                }, 10000);
                
                // Add haptic feedback
                triggerHapticFeedback();
            } else {
                panel.classList.remove('expanded');
                fab.setAttribute('aria-expanded', 'false');
                clearTimeout(timerHubAutoHideTimeout);
            }
        }

        function updateTimerHub() {
            // Throttle updates to prevent excessive DOM manipulation
            if (timerHubUpdateThrottle) {
                clearTimeout(timerHubUpdateThrottle);
            }
            
            timerHubUpdateThrottle = setTimeout(() => {
                performTimerHubUpdate();
            }, 100); // Update at most every 100ms
        }

        function performTimerHubUpdate() {
            const hubList = document.getElementById('timerHubList');
            const badge = document.getElementById('timerHubBadge');
            const fab = document.getElementById('timerHubFab');
            
            if (!hubList || !badge || !fab) return;
            
            // Filter active countdown appointments - Fixed logic
            const now = new Date();
            const activeTimers = appointments.filter(app => {
                const timeUntilAppointment = app.appointmentTime - now;
                
                // Calculate reminder time properly
                const reminderTime = new Date(app.appointmentTime.getTime() - (app.reminderMinutes * 60 * 1000));
                const timeUntilReminder = reminderTime - now;
                
                // Show if:
                // 1. Appointment hasn't started yet (timeUntilAppointment > 0)
                // AND either:
                // 2a. Reminder hasn't triggered yet (timeUntilReminder > 0)
                // 2b. OR we're in countdown phase (reminder triggered but appointment hasn't started)
                return timeUntilAppointment > 0;
            });

            // Create state hash to avoid unnecessary updates
            const currentState = {
                count: activeTimers.length,
                hasUrgent: activeTimers.some(app => {
                    const timeUntilAppointment = app.appointmentTime - now;
                    return timeUntilAppointment <= 5 * 60 * 1000 && timeUntilAppointment > 0;
                }),
                timers: activeTimers.map(app => {
                    const timeUntilAppointment = app.appointmentTime - now;
                    const reminderTime = new Date(app.appointmentTime.getTime() - (app.reminderMinutes * 60 * 1000));
                    const timeUntilReminder = reminderTime - now;
                    
                    return {
                        id: app.id,
                        timeLeft: Math.floor(Math.max(timeUntilReminder, timeUntilAppointment) / 1000),
                        isInCountdown: timeUntilReminder <= 0 && timeUntilAppointment > 0
                    };
                })
            };

            // Only update if state has changed
            if (lastTimerHubState && JSON.stringify(currentState) === JSON.stringify(lastTimerHubState)) {
                return;
            }
            lastTimerHubState = currentState;

            // Update badge efficiently
            requestAnimationFrame(() => {
                if (activeTimers.length > 0) {
                    badge.textContent = activeTimers.length;
                    badge.classList.add('visible');
                    fab.classList.add('has-timers');
                    
                    if (currentState.hasUrgent) {
                        badge.classList.add('urgent');
                    } else {
                        badge.classList.remove('urgent');
                    }
                } else {
                    badge.classList.remove('visible', 'urgent');
                    fab.classList.remove('has-timers');
                }

                // Update timer list only if panel is expanded
                if (timerHubExpanded) {
                    updateTimerHubList(activeTimers);
                }
            });
        }

        function updateTimerHubList(activeTimers) {
            const hubList = document.getElementById('timerHubList');
            if (!hubList) return;

            if (activeTimers.length === 0) {
                hubList.innerHTML = `
                    <div class="timer-hub-empty">
                        <div class="timer-hub-empty-icon">⏰</div>
                        <p class="timer-hub-empty-text">No active timers</p>
                    </div>
                `;
                return;
            }

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            activeTimers.forEach(app => {
                const now = new Date();
                
                // Calculate reminder time properly
                const reminderTime = new Date(app.appointmentTime.getTime() - (app.reminderMinutes * 60 * 1000));
                const timeUntilReminder = reminderTime - now;
                const timeUntilAppointment = app.appointmentTime - now;
                
                let timeToShow, status, itemClass;
                
                // Improved logic for displaying countdown status
                if (timeUntilReminder > 0) {
                    // Before reminder time
                    timeToShow = timeUntilReminder;
                    status = 'Until Reminder';
                    itemClass = 'countdown';
                } else if (timeUntilAppointment > 0) {
                    // After reminder, before appointment (countdown phase)
                    timeToShow = timeUntilAppointment;
                    if (timeUntilAppointment <= 60 * 1000) { // 1 minute
                        status = 'Starting NOW!';
                        itemClass = 'urgent';
                    } else if (timeUntilAppointment <= 5 * 60 * 1000) { // 5 minutes
                        status = 'Starting Soon!';
                        itemClass = 'urgent';
                    } else if (timeUntilAppointment <= 15 * 60 * 1000) { // 15 minutes
                        status = 'Starting Soon';
                        itemClass = 'warning';
                    } else {
                        status = 'Countdown';
                        itemClass = 'countdown';
                    }
                } else {
                    // Past appointment time (shouldn't happen with our filter, but safety)
                    return;
                }
                
                const timeString = formatCountdownTime(timeToShow);
                const typeColor = appointmentColors[app.type] || appointmentColors[app.tag] || appointmentColors['General'];
                const description = app.desc || app.description || app.tag?.substring(0, 2).toUpperCase() || 'AP';
                
                const itemElement = document.createElement('div');
                itemElement.className = `timer-hub-item ${itemClass}`;
                itemElement.setAttribute('tabindex', '0');
                itemElement.setAttribute('role', 'button');
                itemElement.setAttribute('aria-label', `Go to ${description} appointment`);
                
                itemElement.innerHTML = `
                    <div class="timer-hub-item-indicator" style="color: ${typeColor};"></div>
                    <div class="timer-hub-item-content">
                        <div class="timer-hub-item-title">
                            <span style="background: ${typeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;">${description}</span>
                            <span style="opacity: 0.7;">${app.type || app.tag}</span>
                        </div>
                        <div class="timer-hub-item-time">${timeString}</div>
                        <div class="timer-hub-item-status">${status}</div>
                    </div>
                `;
                
                // Add event listeners efficiently
                itemElement.addEventListener('click', () => scrollToAppointment(app.id), { passive: true });
                itemElement.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        scrollToAppointment(app.id);
                    }
                }, { passive: false });
                
                fragment.appendChild(itemElement);
            });

            // Replace content in one operation
            hubList.innerHTML = '';
            hubList.appendChild(fragment);
        }

        function scrollToAppointment(appointmentId) {
            const appointmentElement = document.getElementById(`appointment-${appointmentId}`) || 
                                      document.querySelector(`[data-appointment-id="${appointmentId}"]`);
            if (appointmentElement) {
                // Close timer hub
                if (timerHubExpanded) {
                    toggleTimerHub();
                }
                
                // Smooth scroll to appointment
                appointmentElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Add temporary highlight
                appointmentElement.classList.add('shake-attention');
                setTimeout(() => {
                    appointmentElement.classList.remove('shake-attention');
                }, 600);
                
                // Haptic feedback
                triggerHapticFeedback();
            }
        }

        function formatCountdownTime(milliseconds) {
            if (milliseconds <= 0) return '00:00:00';
            
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Enhanced haptic feedback
        function triggerHapticFeedback(intensity = 'light') {
            if ('vibrate' in navigator) {
                const patterns = {
                    light: [10],
                    medium: [20],
                    heavy: [30]
                };
                navigator.vibrate(patterns[intensity] || patterns.light);
            }
        }

        // Auto-hide timer hub when clicking outside - Optimized
        let clickOutsideHandler = null;

        function setupTimerHubClickOutside() {
            if (clickOutsideHandler) {
                document.removeEventListener('click', clickOutsideHandler);
            }
            
            clickOutsideHandler = (e) => {
                const timerHub = document.getElementById('timerHubContainer');
                if (timerHubExpanded && timerHub && !timerHub.contains(e.target)) {
                    toggleTimerHub();
                }
            };
            
            document.addEventListener('click', clickOutsideHandler, { passive: true });
        }

        // Optimized initialization
        function initializeTimerHub() {
            updateTimerHub();
            setupTimerHubClickOutside();
            
            // Setup intersection observer for efficiency when panel is off-screen
            if ('IntersectionObserver' in window) {
                const timerHubContainer = document.getElementById('timerHubContainer');
                if (timerHubContainer) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                // Timer hub is visible, enable full updates
                                if (timerHubExpanded) {
                                    updateTimerHubList(
                                        appointments.filter(app => {
                                            const now = new Date();
                                            const timeUntilReminder = app.reminderTime - now;
                                            const timeUntilAppointment = app.appointmentTime - now;
                                            return timeUntilReminder > 0 || (timeUntilAppointment > 0 && timeUntilAppointment <= app.reminderMinutes * 60 * 1000);
                                        })
                                    );
                                }
                            }
                        });
                    }, { threshold: 0.1 });
                    
                    observer.observe(timerHubContainer);
                }
            }
        }

        // Initialize the timer hub on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize timer hub with delay to ensure DOM is ready
            setTimeout(() => {
                initializeTimerHub();
                
                // Add demo state if no appointments exist
                if (appointments.length === 0) {
                    const badge = document.getElementById('timerHubBadge');
                    const fab = document.getElementById('timerHubFab');
                    if (badge && fab) {
                        // Show a demo state briefly
                        badge.textContent = '?';
                        badge.classList.add('visible');
                        fab.setAttribute('title', 'Timer hub ready - Add appointments to see active timers');
                        
                        // Remove demo state after 3 seconds
                        setTimeout(() => {
                            if (appointments.length === 0) {
                                badge.classList.remove('visible');
                                fab.setAttribute('title', 'View active timers');
                            }
                        }, 3000);
                    }
                }
            }, 100);
        });

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
